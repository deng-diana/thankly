# P2: 60%进度优化 - 完整修改代码

## 📝 修改文件: backend/app/routers/diary.py

### 修改位置: 第 655-674 行

**当前代码**:

```python
        # 定义任务2：暖心反馈 (50% -> 80%)
        async def task_vision_and_feedback():
            transcription = await transcription_task
            update_task_progress(task_id, "processing", 60, 3, "生成反馈", "正在感受你的心情...", user_id=user['user_id'])

            full_context = content or ""
            if transcription and transcription.strip():
                if full_context.strip():
                    full_context = f"{full_context.strip()}\\n\\n{transcription.strip()}"
                else:
                    full_context = transcription.strip()

            feedback = await openai_service._call_gpt4o_mini_for_feedback(
                full_context,
                user_language,
                user_display_name,
                None
            )
            update_task_progress(task_id, "processing", 80, 3, "生成反馈", "反馈准备就绪", user_id=user['user_id'])
            return feedback
```

**替换为**:

```python
        # 定义任务2：暖心反馈 (50% -> 80%) - ✅ 优化版: 流式进度更新
        async def task_vision_and_feedback():
            # ✅ 优化1: 提前更新进度,让用户知道我们在准备
            update_task_progress(task_id, "processing", 55, 3, "准备反馈", "正在预热AI引擎...", user_id=user['user_id'])

            transcription = await transcription_task

            # ✅ 优化2: 流式进度更新 (60% → 78%)
            update_task_progress(task_id, "processing", 60, 3, "生成反馈", "正在感受你的心情...", user_id=user['user_id'])

            # 启动流式进度更新任务
            async def smooth_progress():
                """
                流式进度更新: 在等待GPT响应时持续更新进度

                📚 学习点: 为什么这样做?
                - GPT调用需要3-5秒,用户会感觉卡顿
                - 通过每0.8秒更新进度,让用户感觉"一直在处理"
                - 心理学: 有反馈的等待比无反馈的等待感觉快3倍
                """
                current_p = 60
                messages = [
                    "AI正在倾听你的故事...",
                    "理解你的情绪...",
                    "准备温暖的回应...",
                    "几乎完成了..."
                ]
                msg_index = 0

                while current_p < 78:  # 不超过78%,留2%给最终更新
                    await asyncio.sleep(0.8)  # 每0.8秒更新一次
                    current_p += 3  # 每次增加3%
                    update_task_progress(
                        task_id,
                        "processing",
                        min(current_p, 78),  # 确保不超过78%
                        3,
                        "生成反馈",
                        messages[min(msg_index, len(messages)-1)],  # 循环使用消息
                        user_id=user['user_id']
                    )
                    msg_index += 1

            # 启动流式进度任务
            progress_task = asyncio.create_task(smooth_progress())

            try:
                # 构建完整上下文
                full_context = content or ""
                if transcription and transcription.strip():
                    if full_context.strip():
                        full_context = f"{full_context.strip()}\\n\\n{transcription.strip()}"
                    else:
                        full_context = transcription.strip()

                # 调用GPT (3-5秒,但用户看到流畅的进度更新)
                feedback = await openai_service._call_gpt4o_mini_for_feedback(
                    full_context,
                    user_language,
                    user_display_name,
                    None
                )

                return feedback
            finally:
                # 取消流式进度更新
                progress_task.cancel()
                # 设置最终进度
                update_task_progress(task_id, "processing", 80, 3, "生成反馈", "反馈准备就绪", user_id=user['user_id'])
```

---

## 🚀 实施步骤

1. 打开文件: `backend/app/routers/diary.py`
2. 找到第 655 行: `# 定义任务2：暖心反馈 (50% -> 80%)`
3. 选中第 655-674 行的整个函数
4. 替换为上面的优化版代码
5. 保存文件

---

## 📊 优化效果

### 优化前:

```
60% ──→ [等待3-5秒,无任何反馈] ──→ 80%
用户感觉: "卡住了吗?"
```

### 优化后:

```
55% → 60% → 62% → 64% → 66% → 68% → 70% → 72% → 74% → 76% → 78% → 80%
     ↑ 每0.8秒更新一次
     ↑ 显示消息: "AI正在倾听..." → "理解你的情绪..." → "准备温暖的回应..."
用户感觉: "很流畅,一直在处理"
```

---

## ⏱️ 预计时间: 2 分钟

完成后请重启后端服务:

```bash
# 在backend目录下
./start-local.sh
```

---

**这个修改非常简单,只需要替换一个函数!** ✅
