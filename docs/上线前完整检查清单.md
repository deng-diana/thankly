# 🚀 上线前完整检查清单和打包指南

## 📋 一、上线前必做检查清单

### ✅ 1. 前端配置检查

#### 1.1 切换 API 地址到生产环境 ⚠️ **最重要**

**文件：** `mobile/src/config/aws-config.ts`  
**修改位置：** 第 41 行

```typescript
// ❌ 开发环境
const IS_LOCAL_DEV = true;

// ✅ 生产环境（必须改为 false）
const IS_LOCAL_DEV = false;
```

**验证方法：**
```bash
cd mobile
# 启动应用后，查看控制台输出
# 应该显示：🔗 API地址: https://... (生产环境)
# 不应该看到：http://192.168.x.x 或 localhost
```

**检查点：**
- [ ] `IS_LOCAL_DEV` 已设置为 `false`
- [ ] `PRODUCTION_URL` 正确（AWS Lambda URL）
- [ ] 控制台输出显示生产环境地址

---

#### 1.2 检查 app.json 配置

**文件：** `mobile/app.json`

**iOS 配置：**
- [ ] `bundleIdentifier` 正确（例如：`com.thankly.app`）
- [ ] `version` 已更新（例如：`1.0.0`）
- [ ] `icon` 路径正确（`./assets/app-icon.png`）
- [ ] `splash.image` 路径正确（`./assets/splash-icon.png`）
- [ ] `infoPlist.NSFaceIDUsageDescription` 已设置

**Android 配置：**
- [ ] `package` 正确（例如：`com.thankly.app`）
- [ ] `version` 已更新
- [ ] `adaptiveIcon.foregroundImage` 路径正确
- [ ] `adaptiveIcon.backgroundColor` 正确（`#FAF6ED`）

**通用配置：**
- [ ] `name` 正确（应用显示名称）
- [ ] `slug` 正确（Expo 项目标识）
- [ ] `scheme` 正确（`myapp`）

---

#### 1.3 验证 Cognito 配置

**文件：** `mobile/src/config/aws-config.ts`

**检查点：**
- [ ] `userPoolId` 正确（`us-east-1_1DgDNffb0`）
- [ ] `userPoolWebClientId` 正确（`6e521vvi1g2a1efbf3l70o83k2`）
- [ ] `oauth.domain` 正确（`auth.thankly.app`）
- [ ] `redirectSignIn` 使用生产环境 scheme（`myapp://callback`）
- [ ] `redirectSignOut` 使用生产环境 scheme（`myapp://signout`）

---

#### 1.4 关闭开发模式开关

**文件：** `mobile/src/navigation/AppNavigator.tsx`

**检查点：**
- [ ] `DEV_MODE_FORCE_ONBOARDING` 已设置为 `false`
- [ ] 移除所有测试路由和调试代码

---

### ✅ 2. 后端配置检查

#### 2.1 Lambda 环境变量配置

**在 AWS Lambda Console 中检查以下环境变量：**

- [ ] `OPENAI_API_KEY` - OpenAI API 密钥
- [ ] `AWS_REGION` - AWS 区域（`us-east-1`）
- [ ] `DYNAMODB_TABLE_NAME` - DynamoDB 表名（`GratitudeDiaries`）
- [ ] `S3_BUCKET_NAME` - S3 存储桶名称
- [ ] `COGNITO_USER_POOL_ID` - Cognito User Pool ID（`us-east-1_1DgDNffb0`）
- [ ] `COGNITO_CLIENT_ID` - Cognito Client ID（`6e521vvi1g2a1efbf3l70o83k2`）
- [ ] `COGNITO_DOMAIN` - Cognito 域名（`auth.thankly.app`）

**验证方法：**
```bash
# 测试 Lambda 健康检查端点
curl https://your-lambda-url.lambda-url.us-east-1.on.aws/health

# 应该返回：
# {"status":"healthy","config":"ok","timestamp":"..."}
```

---

#### 2.2 后端部署验证

**检查点：**
- [ ] Lambda 函数已部署最新代码
- [ ] Lambda Function URL 已启用
- [ ] CORS 配置正确（允许前端域名）
- [ ] IAM 权限正确（DynamoDB、S3、Cognito 访问权限）

---

### ✅ 3. 功能测试

#### 3.1 核心功能测试清单

**用户认证：**
- [ ] Apple 登录流程正常
- [ ] Google 登录流程正常
- [ ] 邮箱注册和登录正常
- [ ] 手机号注册和登录正常
- [ ] 新用户姓名输入提示正常
- [ ] Token 刷新机制正常

**日记功能：**
- [ ] 创建文本日记正常
- [ ] 创建语音日记正常
- [ ] 语音转文字正常
- [ ] AI 润色和标题生成正常
- [ ] AI 反馈生成正常（包含用户名）
- [ ] 日记列表显示正常
- [ ] 日记详情查看正常
- [ ] 音频播放正常（倒计时显示正确）
- [ ] 日记保存到云端正常

**UI/UX：**
- [ ] 欢迎页面显示正常
- [ ] 引导页显示正常
- [ ] 空状态显示正常
- [ ] 加载动画流畅
- [ ] 错误提示友好

**多语言：**
- [ ] 中文界面完整
- [ ] 英文界面完整
- [ ] 语言切换正常

---

#### 3.2 边界情况测试

- [ ] 网络断开时的错误处理
- [ ] API 超时处理
- [ ] 无效输入验证
- [ ] 音频文件过大处理
- [ ] Token 过期处理

---

### ✅ 4. 代码质量检查

#### 4.1 移除调试代码

**检查点：**
- [ ] 移除或注释掉所有 `console.log`（生产环境）
- [ ] 移除测试代码和测试路由
- [ ] 移除硬编码的测试凭据
- [ ] 移除注释掉的废弃代码

**快速检查命令：**
```bash
cd mobile
# 搜索所有 console.log
grep -r "console.log" src/ --exclude-dir=node_modules

# 只保留必要的错误日志（console.error）
```

---

#### 4.2 代码优化

- [ ] 移除未使用的导入
- [ ] 移除未使用的变量
- [ ] 优化图片资源大小
- [ ] 检查是否有内存泄漏

---

### ✅ 5. 安全和隐私检查

#### 5.1 敏感信息检查

- [ ] 没有硬编码的 API 密钥
- [ ] 没有硬编码的密码
- [ ] 所有敏感信息通过环境变量或配置文件管理
- [ ] `.env` 文件已添加到 `.gitignore`

---

#### 5.2 隐私政策和服务条款

**检查点：**
- [ ] 隐私政策内容完整
- [ ] 服务条款内容完整
- [ ] 隐私政策包含所有收集的数据说明
- [ ] 隐私政策包含第三方服务说明
- [ ] 隐私政策 URL 可访问（如果托管在外部）

---

### ✅ 6. 资源文件检查

#### 6.1 图标和启动画面

- [ ] `app-icon.png` 存在且尺寸正确（1024x1024）
- [ ] `splash-icon.png` 存在且尺寸正确（1024x1024）
- [ ] iOS App Icon 已配置
- [ ] Android Adaptive Icon 已配置

---

#### 6.2 SVG 图标

- [ ] 所有 SVG 图标文件存在
- [ ] SVG 图标在应用中正常显示
- [ ] 图标尺寸和颜色正确

---

## 📦 二、打包和提交步骤

### 📱 方式一：使用 EAS Build（推荐）

#### 步骤 1: 安装 EAS CLI

```bash
npm install -g eas-cli
```

#### 步骤 2: 登录 Expo 账户

```bash
eas login
```

#### 步骤 3: 配置 EAS Build

```bash
cd mobile
eas build:configure
```

这会创建 `eas.json` 配置文件。

#### 步骤 4: 构建 iOS 应用

```bash
# 构建 iOS 应用（需要 Apple Developer 账户）
eas build --platform ios

# 或者构建本地版本（需要 Xcode）
eas build --platform ios --local
```

**注意事项：**
- 需要 Apple Developer 账户（$99/年）
- 需要配置 App Store Connect
- 需要提供证书和配置文件

#### 步骤 5: 构建 Android 应用

```bash
# 构建 Android 应用
eas build --platform android

# 或者构建本地版本
eas build --platform android --local
```

#### 步骤 6: 提交到应用商店

**iOS (App Store):**
```bash
# 使用 EAS Submit 提交到 App Store Connect
eas submit --platform ios
```

**Android (Google Play):**
```bash
# 使用 EAS Submit 提交到 Google Play Console
eas submit --platform android
```

---

### 📱 方式二：使用 Expo 经典构建（已弃用，但仍可用）

#### 步骤 1: 登录 Expo

```bash
cd mobile
npx expo login
```

#### 步骤 2: 构建应用

**iOS:**
```bash
npx expo build:ios
```

**Android:**
```bash
npx expo build:android
```

**注意：** Expo 经典构建服务已弃用，建议使用 EAS Build。

---

### 📱 方式三：本地构建（需要 Xcode/Android Studio）

#### iOS 本地构建

```bash
cd mobile

# 1. 生成 iOS 项目
npx expo prebuild --platform ios

# 2. 在 Xcode 中打开项目
open ios/YourApp.xcworkspace

# 3. 在 Xcode 中配置签名和证书
# 4. 在 Xcode 中构建和归档（Product > Archive）
# 5. 在 Xcode Organizer 中提交到 App Store
```

#### Android 本地构建

```bash
cd mobile

# 1. 生成 Android 项目
npx expo prebuild --platform android

# 2. 在 Android Studio 中打开项目
# 打开 android/ 目录

# 3. 构建 APK 或 AAB
./gradlew assembleRelease  # APK
./gradlew bundleRelease    # AAB (用于 Google Play)

# 4. 输出位置：
# APK: android/app/build/outputs/apk/release/app-release.apk
# AAB: android/app/build/outputs/bundle/release/app-release.aab
```

---

## 🎯 三、提交到应用商店前的准备

### 📱 iOS (App Store Connect)

#### 必需材料：

1. **应用信息**
   - [ ] 应用名称
   - [ ] 副标题
   - [ ] 关键词
   - [ ] 描述（中英文）
   - [ ] 支持 URL
   - [ ] 营销 URL（可选）

2. **截图**
   - [ ] iPhone 6.7" (iPhone 14 Pro Max) - 至少 1 张
   - [ ] iPhone 6.5" (iPhone 11 Pro Max) - 至少 1 张
   - [ ] iPhone 5.5" (iPhone 8 Plus) - 至少 1 张
   - [ ] iPad Pro 12.9" - 如果支持 iPad

3. **隐私信息**
   - [ ] 隐私政策 URL
   - [ ] 数据收集说明
   - [ ] 第三方服务说明

4. **App Store 审核信息**
   - [ ] 联系信息
   - [ ] 审核备注（如有需要）
   - [ ] 演示账户（如有需要）

---

### 📱 Android (Google Play Console)

#### 必需材料：

1. **应用信息**
   - [ ] 应用名称
   - [ ] 简短描述（80 字符）
   - [ ] 完整描述（4000 字符）
   - [ ] 图形资源（图标、功能图形、截图）

2. **截图**
   - [ ] 手机截图（至少 2 张，最多 8 张）
   - [ ] 平板截图（如果支持，至少 2 张）
   - [ ] 7" 平板截图（如果支持）

3. **隐私和安全**
   - [ ] 隐私政策 URL（必需）
   - [ ] 数据安全部分填写
   - [ ] 目标受众和内容分级

4. **应用内容**
   - [ ] 内容分级问卷
   - [ ] 广告 ID 政策（如果使用）
   - [ ] 数据共享说明

---

## ✅ 四、最终验证清单

在提交审核前，最后检查：

### 配置验证
- [ ] `IS_LOCAL_DEV = false`
- [ ] API 地址指向生产环境
- [ ] Cognito 配置正确
- [ ] 所有环境变量已配置

### 功能验证
- [ ] 所有核心功能正常
- [ ] 错误处理完善
- [ ] 用户体验流畅

### 代码质量
- [ ] 移除所有调试代码
- [ ] 代码整洁无警告
- [ ] 资源文件完整

### 商店准备
- [ ] 截图准备完成
- [ ] 描述文案完成
- [ ] 隐私政策 URL 可访问
- [ ] 审核信息填写完整

---

## 🚨 常见问题和解决方案

### 问题 1: 构建失败 - "No bundle identifier"

**解决方案：**
- 检查 `app.json` 中的 `bundleIdentifier` 或 `package`
- 确保格式正确（例如：`com.yourcompany.appname`）

### 问题 2: 构建失败 - "Missing API key"

**解决方案：**
- 检查 Lambda 环境变量是否配置
- 检查前端配置是否正确

### 问题 3: 应用无法连接 API

**解决方案：**
- 确认 `IS_LOCAL_DEV = false`
- 检查 Lambda Function URL 是否正确
- 检查 CORS 配置

### 问题 4: 登录失败

**解决方案：**
- 检查 Cognito 配置
- 检查 redirect URIs 配置
- 检查域名配置

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. Expo 文档：https://docs.expo.dev/
2. EAS Build 文档：https://docs.expo.dev/build/introduction/
3. AWS Lambda 文档：https://docs.aws.amazon.com/lambda/

---

**最后更新：** 2025-01-XX  
**维护者：** 开发团队

