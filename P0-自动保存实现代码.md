# P0 ç´§æ€¥ä¿®å¤: è‡ªåŠ¨ä¿å­˜å®ç°ä»£ç 

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–‡ä»¶ 1: CreateTextDiaryScreen.tsx

#### ä¿®æ”¹ä½ç½® 1: æ·»åŠ  import (ç¬¬ 26 è¡Œå)

```typescript
import AsyncStorage from "@react-native-async-storage/async-storage";
```

#### ä¿®æ”¹ä½ç½® 2: æ·»åŠ å¸¸é‡ (ç¬¬ 31 è¡Œå)

```typescript
// âœ… è‡ªåŠ¨ä¿å­˜é…ç½®
const AUTO_SAVE_KEY = "draft_text_diary";
const AUTO_SAVE_INTERVAL = 3000; // 3ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
const MAX_DRAFT_AGE = 24 * 60 * 60 * 1000; // 24å°æ—¶
```

#### ä¿®æ”¹ä½ç½® 3: æ·»åŠ çŠ¶æ€ (ç¬¬ 52 è¡Œå)

```typescript
// âœ… è‡ªåŠ¨ä¿å­˜çŠ¶æ€
const [isDraftRestored, setIsDraftRestored] = useState(false);
const [lastSaved, setLastSaved] = useState<Date | null>(null);
const autoSaveTimerRef = useRef<NodeJS.Timeout | null>(null);
```

#### ä¿®æ”¹ä½ç½® 4: æ·»åŠ æ¢å¤è‰ç¨¿é€»è¾‘ (ç¬¬ 79 è¡Œå,åœ¨ç°æœ‰ useEffect ä¹‹å)

```typescript
// âœ… æ–°å¢: Appå¯åŠ¨æ—¶æ¢å¤è‰ç¨¿
useEffect(() => {
  const restoreDraft = async () => {
    try {
      const draft = await AsyncStorage.getItem(AUTO_SAVE_KEY);
      if (draft) {
        const draftData = JSON.parse(draft);

        // æ£€æŸ¥è‰ç¨¿æ˜¯å¦è¿‡æœŸ (24å°æ—¶)
        const now = Date.now();
        const draftAge = now - draftData.timestamp;

        if (draftAge < MAX_DRAFT_AGE && draftData.content.trim()) {
          // æç¤ºç”¨æˆ·æ¢å¤è‰ç¨¿
          Alert.alert(
            "å‘ç°æœªä¿å­˜çš„å†…å®¹",
            `æ˜¯å¦æ¢å¤ä¸Šæ¬¡æœªä¿å­˜çš„å†…å®¹? (${draftData.content.substring(
              0,
              30
            )}...)`,
            [
              {
                text: "æ”¾å¼ƒ",
                style: "destructive",
                onPress: async () => {
                  await AsyncStorage.removeItem(AUTO_SAVE_KEY);
                  setIsDraftRestored(true);
                },
              },
              {
                text: "æ¢å¤",
                onPress: () => {
                  setContent(draftData.content);
                  console.log(
                    "âœ… å·²æ¢å¤è‰ç¨¿:",
                    draftData.content.substring(0, 50)
                  );
                  setIsDraftRestored(true);
                },
              },
            ]
          );
        } else {
          // è‰ç¨¿è¿‡æœŸæˆ–ä¸ºç©º,åˆ é™¤
          await AsyncStorage.removeItem(AUTO_SAVE_KEY);
          setIsDraftRestored(true);
        }
      } else {
        setIsDraftRestored(true);
      }
    } catch (error) {
      console.error("âŒ æ¢å¤è‰ç¨¿å¤±è´¥:", error);
      setIsDraftRestored(true);
    }
  };

  restoreDraft();
}, []);

// âœ… æ–°å¢: è‡ªåŠ¨ä¿å­˜è‰ç¨¿
useEffect(() => {
  // ç­‰å¾…è‰ç¨¿æ¢å¤å®Œæˆåå†å¼€å§‹è‡ªåŠ¨ä¿å­˜
  if (!isDraftRestored) return;

  // å¦‚æœå†…å®¹ä¸ºç©º,ä¸ä¿å­˜
  if (!content.trim()) {
    return;
  }

  // å¦‚æœå·²ç»æäº¤,ä¸ä¿å­˜
  if (submitted) {
    return;
  }

  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (autoSaveTimerRef.current) {
    clearTimeout(autoSaveTimerRef.current);
  }

  // è®¾ç½®æ–°çš„å®šæ—¶å™¨ (3ç§’åä¿å­˜)
  autoSaveTimerRef.current = setTimeout(async () => {
    try {
      const draftData = {
        content: content,
        timestamp: Date.now(),
      };

      await AsyncStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(draftData));
      setLastSaved(new Date());
      console.log("ğŸ’¾ è‡ªåŠ¨ä¿å­˜è‰ç¨¿:", content.substring(0, 30) + "...");
    } catch (error) {
      console.error("âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:", error);
    }
  }, AUTO_SAVE_INTERVAL);

  // æ¸…ç†å‡½æ•°
  return () => {
    if (autoSaveTimerRef.current) {
      clearTimeout(autoSaveTimerRef.current);
    }
  };
}, [content, isDraftRestored, submitted]);
```

#### ä¿®æ”¹ä½ç½® 5: ä¿®æ”¹ handleTextSubmit å‡½æ•° (ç¬¬ 162 è¡Œå¼€å§‹)

åœ¨æˆåŠŸåˆ›å»ºæ—¥è®°åæ·»åŠ æ¸…é™¤è‰ç¨¿çš„ä»£ç :

```typescript
// åœ¨ç¬¬214è¡Œ setCurrentDiaryId(diary.diary_id); ä¹‹åæ·»åŠ :
// âœ… æˆåŠŸåæ¸…é™¤è‰ç¨¿
await AsyncStorage.removeItem(AUTO_SAVE_KEY);
console.log("âœ… å·²æ¸…é™¤è‰ç¨¿ (æˆåŠŸæäº¤)");
```

#### ä¿®æ”¹ä½ç½® 6: ä¿®æ”¹ handleGoBack å‡½æ•° (ç¬¬ 323 è¡Œå¼€å§‹)

æ›¿æ¢æ•´ä¸ªå‡½æ•°:

```typescript
const handleGoBack = async () => {
  // âœ… å¦‚æœæœ‰æœªæäº¤çš„å†…å®¹
  if (content.trim() && !submitted) {
    Alert.alert(
      "ç¡®å®šè¦ç¦»å¼€å—?",
      "æ‚¨è¾“å…¥çš„å†…å®¹å°†è‡ªåŠ¨ä¿å­˜ä¸ºè‰ç¨¿,ä¸‹æ¬¡æ‰“å¼€æ—¶å¯ä»¥æ¢å¤ã€‚",
      [
        {
          text: "ç»§ç»­ç¼–è¾‘",
          style: "cancel",
        },
        {
          text: "ç¦»å¼€",
          onPress: () => navigation.goBack(),
        },
      ]
    );
    return;
  }

  // âœ… å¦‚æœç”¨æˆ·æ­£åœ¨ç¼–è¾‘,æç¤ºæ˜¯å¦ä¿å­˜
  if (isEditing && hasChanges) {
    Alert.alert(t("diary.unsavedChanges"), t("diary.unsavedChangesMessage"), [
      {
        text: t("diary.dontSave"),
        style: "destructive",
        onPress: () => navigation.goBack(),
      },
      {
        text: t("common.save"),
        onPress: async () => {
          try {
            await handleSave();
            navigation.goBack();
          } catch (error) {
            console.error("ä¿å­˜å¤±è´¥ï¼Œä¸å¯¼èˆª:", error);
          }
        },
      },
    ]);
    return;
  }

  // ç›´æ¥è¿”å›
  navigation.goBack();
};
```

#### ä¿®æ”¹ä½ç½® 7: æ·»åŠ ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨ (åœ¨ UI ä¸­,ç¬¬ 428 è¡Œé™„è¿‘,å­—æ•°è®¡æ•°å™¨ä¸‹æ–¹)

```typescript
{
  /* å­—æ•°è®¡æ•°å™¨åœ¨è¾“å…¥æ¡†å†…å³ä¸‹è§’ */
}
<Text
  style={[
    styles.charCount,
    !isTextValid && content.length > 0 && styles.charCountWarning,
  ]}
>
  {content.length}/1000
</Text>;

{
  /* âœ… æ–°å¢: è‡ªåŠ¨ä¿å­˜æŒ‡ç¤ºå™¨ */
}
{
  lastSaved && !submitted && (
    <Text style={styles.savedIndicator}>
      ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜äº {lastSaved.toLocaleTimeString()}
    </Text>
  );
}
```

#### ä¿®æ”¹ä½ç½® 8: æ·»åŠ æ ·å¼ (åœ¨ styles å¯¹è±¡ä¸­,ç¬¬ 693 è¡Œå)

```typescript
toastText: {
  color: "#fff",
  fontSize: 14,
  fontWeight: "600",
},

// âœ… æ–°å¢: è‡ªåŠ¨ä¿å­˜æŒ‡ç¤ºå™¨æ ·å¼
savedIndicator: {
  position: "absolute",
  left: 16,
  bottom: 12,
  fontSize: 10,
  color: "#999",
  fontStyle: "italic",
},
```

---

## ğŸš€ å¿«é€Ÿå®æ–½æ­¥éª¤

### æ­¥éª¤ 1: æ‰“å¼€æ–‡ä»¶

```
æ‰“å¼€: mobile/src/screens/CreateTextDiaryScreen.tsx
```

### æ­¥éª¤ 2: æŒ‰é¡ºåºåº”ç”¨ä¿®æ”¹

1. ç¬¬ 26 è¡Œå: æ·»åŠ  AsyncStorage import
2. ç¬¬ 31 è¡Œå: æ·»åŠ å¸¸é‡å®šä¹‰
3. ç¬¬ 52 è¡Œå: æ·»åŠ çŠ¶æ€å˜é‡
4. ç¬¬ 79 è¡Œå: æ·»åŠ ä¸¤ä¸ª useEffect (æ¢å¤è‰ç¨¿ + è‡ªåŠ¨ä¿å­˜)
5. ç¬¬ 214 è¡Œå: æ·»åŠ æ¸…é™¤è‰ç¨¿ä»£ç 
6. ç¬¬ 323 è¡Œ: æ›¿æ¢ handleGoBack å‡½æ•°
7. ç¬¬ 428 è¡Œé™„è¿‘: æ·»åŠ ä¿å­˜æŒ‡ç¤ºå™¨ UI
8. ç¬¬ 693 è¡Œå: æ·»åŠ æ ·å¼

### æ­¥éª¤ 3: ä¿å­˜æ–‡ä»¶

### æ­¥éª¤ 4: æµ‹è¯•

1. è¾“å…¥ä¸€äº›æ–‡å­—
2. ç­‰å¾… 3 ç§’,æŸ¥çœ‹ console æ˜¯å¦æ˜¾ç¤º"ğŸ’¾ è‡ªåŠ¨ä¿å­˜è‰ç¨¿"
3. å¼ºåˆ¶å…³é—­ App
4. é‡æ–°æ‰“å¼€ App
5. åº”è¯¥çœ‹åˆ°"å‘ç°æœªä¿å­˜çš„å†…å®¹"æç¤º

---

## â±ï¸ é¢„è®¡æ—¶é—´: 15-20 åˆ†é’Ÿ

å®Œæˆåè¯·å‘Šè¯‰æˆ‘,æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€æ­¥!
