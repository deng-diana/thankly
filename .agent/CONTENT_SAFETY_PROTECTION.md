# å†…å®¹å®‰å…¨ä¿æŠ¤æœºåˆ¶ - ç”¨æˆ·è¾“å…¥å†…å®¹å®ˆæŠ¤

**ç‰ˆæœ¬**: v1.0  
**è®¾è®¡ç›®æ ‡**: ç¡®ä¿ç”¨æˆ·è¾“å…¥çš„å†…å®¹åœ¨å„ç§ edge cases ä¸‹ä¸ä¼šä¸¢å¤±  
**è®¾è®¡ç†å¿µ**: å¤šå±‚é˜²æŠ¤ï¼Œä¸‡æ— ä¸€å¤±

---

## ðŸ›¡ï¸ ä¿æŠ¤æœºåˆ¶æ€»è§ˆ

### **æ ¸å¿ƒåŽŸåˆ™**
> **ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ˜¯çè´µçš„ï¼Œå¿…é¡»ç”¨ä»£ç å®ˆæŠ¤ï¼Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šä¸¢å¤±ã€‚**

---

## ðŸ“‹ å·²å®žçŽ°çš„ä¿æŠ¤æœºåˆ¶

### **1. å®šæ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆåŸºç¡€ä¿æŠ¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- æ¯ 5 ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡è‰ç¨¿åˆ° `AsyncStorage`
- ä½¿ç”¨ `setTimeout` å®žçŽ°ï¼Œé¿å…é¢‘ç¹ä¿å­˜
- åªåœ¨æœ‰å†…å®¹æ—¶ä¿å­˜ï¼Œç©ºå†…å®¹ä¸ä¿å­˜

**ä»£ç ä½ç½®**:
```typescript
// 5ç§’å®šæ—¶ä¿å­˜
autoSaveTimerRef.current = setTimeout(async () => {
  const draftData = {
    content: content, // æˆ– textContent + images
    timestamp: Date.now()
  };
  await AsyncStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(draftData));
}, AUTO_SAVE_INTERVAL);
```

**ä¿æŠ¤åœºæ™¯**:
- âœ… ç”¨æˆ·æ­£å¸¸è¾“å…¥è¿‡ç¨‹ä¸­
- âœ… ç½‘ç»œä¸å¥½æ—¶ï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œä¸å—ç½‘ç»œå½±å“ï¼‰

---

### **2. åº”ç”¨åˆ‡æ¢åˆ°åŽå°æ—¶ç«‹å³ä¿å­˜ï¼ˆå…³é”®ä¿æŠ¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- ç›‘å¬ `AppState` å˜åŒ–
- å½“åº”ç”¨åˆ‡æ¢åˆ° `background` æˆ– `inactive` çŠ¶æ€æ—¶ï¼Œç«‹å³ä¿å­˜
- ä¸ç­‰å¾… 5 ç§’å®šæ—¶å™¨ï¼Œç¡®ä¿å†…å®¹ä¸ä¸¢å¤±

**ä»£ç ä½ç½®**:
```typescript
useEffect(() => {
  if (!visible) return;

  const subscription = AppState.addEventListener("change", (nextAppState) => {
    if (nextAppState === "background" || nextAppState === "inactive") {
      // åº”ç”¨åˆ‡æ¢åˆ°åŽå°ï¼Œç«‹å³ä¿å­˜
      saveDraftImmediately();
    }
  });

  return () => {
    subscription.remove();
  };
}, [visible, saveDraftImmediately]);
```

**ä¿æŠ¤åœºæ™¯**:
- âœ… ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨
- âœ… ç³»ç»Ÿé€šçŸ¥æ‰“æ–­
- âœ… ç”µè¯æ¥ç”µ
- âœ… åº”ç”¨è¢«ç³»ç»ŸæŒ‚èµ·

---

### **3. ç»„ä»¶å¸è½½å‰ç«‹å³ä¿å­˜ï¼ˆé—ªé€€ä¿æŠ¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- åœ¨ç»„ä»¶å¸è½½çš„æ¸…ç†å‡½æ•°ä¸­ï¼Œç«‹å³ä¿å­˜å½“å‰å†…å®¹
- è¿™æ˜¯æœ€åŽä¸€é“é˜²çº¿ï¼Œé˜²æ­¢åº”ç”¨é—ªé€€å¯¼è‡´å†…å®¹ä¸¢å¤±

**ä»£ç ä½ç½®**:
```typescript
useEffect(() => {
  return () => {
    // ç»„ä»¶å¸è½½æ—¶ï¼Œç«‹å³ä¿å­˜å½“å‰å†…å®¹
    if (content.trim() && !showResult && !isProcessing) {
      saveDraftImmediately();
    }
    // æ¸…ç†å®šæ—¶å™¨
    if (autoSaveTimerRef.current) {
      clearTimeout(autoSaveTimerRef.current);
    }
  };
}, [content, showResult, isProcessing, saveDraftImmediately]);
```

**ä¿æŠ¤åœºæ™¯**:
- âœ… åº”ç”¨çªç„¶é—ªé€€
- âœ… å†…å­˜ä¸è¶³è¢«ç³»ç»Ÿæ€æ­»
- âœ… ç»„ä»¶æ„å¤–å¸è½½
- âœ… åº”ç”¨å´©æºƒ

---

### **4. Modal å…³é—­å‰ç«‹å³ä¿å­˜ï¼ˆæ„å¤–å…³é—­ä¿æŠ¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- å½“ Modal çš„ `visible` å˜ä¸º `false` æ—¶ï¼Œç«‹å³æ£€æŸ¥å¹¶ä¿å­˜
- å³ä½¿é€šè¿‡ç³»ç»Ÿæ‰‹åŠ¿å…³é—­ï¼Œä¹Ÿèƒ½ä¿å­˜å†…å®¹

**ä»£ç ä½ç½®**:
```typescript
if (!visible) {
  // Modal å…³é—­å‰ï¼Œå¦‚æžœæœ‰æœªä¿å­˜å†…å®¹ï¼Œç«‹å³ä¿å­˜
  if (content.trim() && !showResult && !isProcessing) {
    saveDraftImmediately();
  }
  // ç„¶åŽé‡ç½®çŠ¶æ€...
}
```

**ä¿æŠ¤åœºæ™¯**:
- âœ… ç”¨æˆ·é€šè¿‡ä¸‹æ‹‰æ‰‹åŠ¿å…³é—­ Modal
- âœ… ç³»ç»Ÿè‡ªåŠ¨å…³é—­ Modal
- âœ… æ„å¤–è§¦å‘å…³é—­æ“ä½œ

---

### **5. è‰ç¨¿è‡ªåŠ¨æ¢å¤ï¼ˆå†…å®¹æ¢å¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- Modal æ‰“å¼€æ—¶ï¼Œè‡ªåŠ¨ä»Ž `AsyncStorage` æ¢å¤è‰ç¨¿
- ç›´æŽ¥æ¢å¤åˆ°è¾“å…¥æ¡†ï¼Œä¸å¼¹çª—è¯¢é—®ï¼ˆæå‡ä½“éªŒï¼‰
- æ£€æŸ¥è‰ç¨¿æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰

**ä»£ç ä½ç½®**:
```typescript
const restoreDraft = async () => {
  const draft = await AsyncStorage.getItem(AUTO_SAVE_KEY);
  if (draft) {
    const draftData = JSON.parse(draft);
    const draftAge = Date.now() - draftData.timestamp;
    
    if (draftAge < MAX_DRAFT_AGE && draftData.content.trim()) {
      // ç›´æŽ¥æ¢å¤åˆ°è¾“å…¥æ¡†
      setContent(draftData.content);
      hasUnsavedContentRef.current = true;
    }
  }
};
```

**ä¿æŠ¤åœºæ™¯**:
- âœ… ç”¨æˆ·é‡æ–°æ‰“å¼€ Modal
- âœ… åº”ç”¨é‡å¯åŽ
- âœ… é¡µé¢åˆ·æ–°åŽ

---

### **6. å…³é—­ç¡®è®¤å¼¹çª—ï¼ˆç”¨æˆ·ä¸»åŠ¨ä¿æŠ¤ï¼‰**

**å®žçŽ°ä½ç½®**: `TextInputModal.tsx`, `ImageDiaryModal.tsx`

**æœºåˆ¶**:
- ç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶ï¼Œå¦‚æžœæœ‰æœªä¿å­˜å†…å®¹ï¼Œå¼¹å‡ºç¡®è®¤å¼¹çª—
- æä¾›"ä¿å­˜è‰ç¨¿"å’Œ"ä¸ä¿å­˜"ä¸¤ä¸ªé€‰é¡¹
- ç¡®ä¿ç”¨æˆ·ä¸ä¼šè¯¯æ“ä½œä¸¢å¤±å†…å®¹

**ä¿æŠ¤åœºæ™¯**:
- âœ… ç”¨æˆ·è¯¯è§¦å…³é—­æŒ‰é’®
- âœ… ç”¨æˆ·æƒ³è¦ç¦»å¼€ä½†å¿˜è®°ä¿å­˜

---

## ðŸŽ¯ Edge Cases è¦†ç›–

### **å·²è¦†ç›–çš„åœºæ™¯**

| Edge Case | ä¿æŠ¤æœºåˆ¶ | çŠ¶æ€ |
|-----------|---------|------|
| ç½‘ç»œä¸å¥½ | æœ¬åœ°å­˜å‚¨ï¼ˆAsyncStorageï¼‰ | âœ… å·²è¦†ç›– |
| ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨ | AppState ç›‘å¬ + ç«‹å³ä¿å­˜ | âœ… å·²è¦†ç›– |
| åº”ç”¨çªç„¶é—ªé€€ | ç»„ä»¶å¸è½½å‰ä¿å­˜ | âœ… å·²è¦†ç›– |
| å†…å­˜ä¸è¶³è¢«ç³»ç»Ÿæ€æ­» | ç»„ä»¶å¸è½½å‰ä¿å­˜ | âœ… å·²è¦†ç›– |
| åº”ç”¨å´©æºƒ | ç»„ä»¶å¸è½½å‰ä¿å­˜ | âœ… å·²è¦†ç›– |
| ç”¨æˆ·è¯¯è§¦å…³é—­ | å…³é—­ç¡®è®¤å¼¹çª— | âœ… å·²è¦†ç›– |
| ç³»ç»Ÿæ‰‹åŠ¿å…³é—­ | Modal å…³é—­å‰ä¿å­˜ | âœ… å·²è¦†ç›– |
| ç”µè¯æ¥ç”µæ‰“æ–­ | AppState ç›‘å¬ + ç«‹å³ä¿å­˜ | âœ… å·²è¦†ç›– |
| ç³»ç»Ÿé€šçŸ¥æ‰“æ–­ | AppState ç›‘å¬ + ç«‹å³ä¿å­˜ | âœ… å·²è¦†ç›– |
| åº”ç”¨è¢«ç³»ç»ŸæŒ‚èµ· | AppState ç›‘å¬ + ç«‹å³ä¿å­˜ | âœ… å·²è¦†ç›– |
| ç”¨æˆ·é‡æ–°æ‰“å¼€ | è‰ç¨¿è‡ªåŠ¨æ¢å¤ | âœ… å·²è¦†ç›– |
| åº”ç”¨é‡å¯ | è‰ç¨¿è‡ªåŠ¨æ¢å¤ | âœ… å·²è¦†ç›– |

---

## ðŸ”’ å®‰å…¨ä¿æŠ¤å±‚çº§

### **ç¬¬ä¸€å±‚ï¼šå®šæ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆ5ç§’ï¼‰**
- åŸºç¡€ä¿æŠ¤ï¼Œæ­£å¸¸è¾“å…¥è¿‡ç¨‹ä¸­æŒç»­ä¿å­˜

### **ç¬¬äºŒå±‚ï¼šåº”ç”¨çŠ¶æ€ç›‘å¬ï¼ˆç«‹å³ä¿å­˜ï¼‰**
- åº”ç”¨åˆ‡æ¢åˆ°åŽå°æ—¶ç«‹å³ä¿å­˜
- ä¸ç­‰å¾…å®šæ—¶å™¨ï¼Œç¡®ä¿å…³é”®æ—¶åˆ»å†…å®¹ä¸ä¸¢å¤±

### **ç¬¬ä¸‰å±‚ï¼šç»„ä»¶å¸è½½ä¿æŠ¤ï¼ˆç«‹å³ä¿å­˜ï¼‰**
- ç»„ä»¶å¸è½½å‰ç«‹å³ä¿å­˜
- é˜²æ­¢åº”ç”¨é—ªé€€ã€å´©æºƒå¯¼è‡´å†…å®¹ä¸¢å¤±

### **ç¬¬å››å±‚ï¼šModal å…³é—­ä¿æŠ¤ï¼ˆç«‹å³ä¿å­˜ï¼‰**
- Modal å…³é—­å‰ç«‹å³ä¿å­˜
- é˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´å†…å®¹ä¸¢å¤±

### **ç¬¬äº”å±‚ï¼šç”¨æˆ·ç¡®è®¤ä¿æŠ¤ï¼ˆäº¤äº’ä¿æŠ¤ï¼‰**
- å…³é—­ç¡®è®¤å¼¹çª—
- è®©ç”¨æˆ·æ˜Žç¡®é€‰æ‹©æ˜¯å¦ä¿å­˜

### **ç¬¬å…­å±‚ï¼šè‰ç¨¿è‡ªåŠ¨æ¢å¤ï¼ˆå†…å®¹æ¢å¤ï¼‰**
- ä¸‹æ¬¡æ‰“å¼€æ—¶è‡ªåŠ¨æ¢å¤
- ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°ä¹‹å‰è¾“å…¥çš„å†…å®¹

---

## ðŸ“Š æ•°æ®æµ

### **ä¿å­˜æµç¨‹**
```
ç”¨æˆ·è¾“å…¥
  â†“
5ç§’å®šæ—¶å™¨è§¦å‘ â†’ ä¿å­˜åˆ° AsyncStorage
  â†“
åº”ç”¨åˆ‡æ¢åˆ°åŽå° â†’ ç«‹å³ä¿å­˜åˆ° AsyncStorage
  â†“
ç»„ä»¶å¸è½½ â†’ ç«‹å³ä¿å­˜åˆ° AsyncStorage
  â†“
Modal å…³é—­ â†’ ç«‹å³ä¿å­˜åˆ° AsyncStorage
```

### **æ¢å¤æµç¨‹**
```
Modal æ‰“å¼€
  â†“
æ£€æŸ¥ AsyncStorage æ˜¯å¦æœ‰è‰ç¨¿
  â†“
å¦‚æžœæœ‰ä¸”æœªè¿‡æœŸ â†’ ç›´æŽ¥æ¢å¤åˆ°è¾“å…¥æ¡†
  â†“
ç”¨æˆ·ç»§ç»­ç¼–è¾‘
```

---

## âœ… éªŒè¯æ¸…å•

- [x] å®šæ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆ5ç§’ï¼‰
- [x] åº”ç”¨åˆ‡æ¢åˆ°åŽå°æ—¶ç«‹å³ä¿å­˜
- [x] ç»„ä»¶å¸è½½å‰ç«‹å³ä¿å­˜
- [x] Modal å…³é—­å‰ç«‹å³ä¿å­˜
- [x] å…³é—­ç¡®è®¤å¼¹çª—
- [x] è‰ç¨¿è‡ªåŠ¨æ¢å¤
- [x] ç½‘ç»œä¸å¥½æ—¶çš„ä¿æŠ¤ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
- [x] åº”ç”¨é—ªé€€æ—¶çš„ä¿æŠ¤
- [x] ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨æ—¶çš„ä¿æŠ¤
- [x] ç³»ç»Ÿæ‰“æ–­æ—¶çš„ä¿æŠ¤

---

## ðŸŽ¯ è®¾è®¡åŽŸåˆ™

1. **å¤šå±‚é˜²æŠ¤**: ä¸ä¾èµ–å•ä¸€æœºåˆ¶ï¼Œå¤šå±‚ä¿æŠ¤ç¡®ä¿ä¸‡æ— ä¸€å¤±
2. **ç«‹å³ä¿å­˜**: å…³é”®æ—¶åˆ»ï¼ˆåŽå°ã€å¸è½½ã€å…³é—­ï¼‰ç«‹å³ä¿å­˜ï¼Œä¸ç­‰å¾…å®šæ—¶å™¨
3. **è‡ªåŠ¨æ¢å¤**: ç”¨æˆ·é‡æ–°æ‰“å¼€æ—¶è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
4. **æœ¬åœ°å­˜å‚¨**: ä½¿ç”¨ AsyncStorageï¼Œä¸å—ç½‘ç»œå½±å“
5. **ç”¨æˆ·å‹å¥½**: è‡ªåŠ¨ä¿å­˜ï¼Œä¸æ‰“æ‰°ç”¨æˆ·ï¼Œæå‡ä½“éªŒ

---

## ðŸ“ æŠ€æœ¯ç»†èŠ‚

### **å­˜å‚¨æ ¼å¼**
```typescript
{
  content: string,        // æ–‡å­—å†…å®¹ï¼ˆTextInputModalï¼‰
  textContent: string,    // æ–‡å­—å†…å®¹ï¼ˆImageDiaryModalï¼‰
  images: string[],       // å›¾ç‰‡åˆ—è¡¨ï¼ˆImageDiaryModalï¼‰
  timestamp: number       // ä¿å­˜æ—¶é—´æˆ³
}
```

### **è¿‡æœŸæœºåˆ¶**
- è‰ç¨¿ä¿å­˜ 24 å°æ—¶åŽè‡ªåŠ¨è¿‡æœŸ
- è¿‡æœŸè‰ç¨¿åœ¨æ¢å¤æ—¶è‡ªåŠ¨åˆ é™¤

### **æ€§èƒ½ä¼˜åŒ–**
- ä½¿ç”¨ `useCallback` é¿å…é‡å¤åˆ›å»ºå‡½æ•°
- ä½¿ç”¨ `useRef` å­˜å‚¨å®šæ—¶å™¨å¼•ç”¨
- ä½¿ç”¨ `AsyncStorage` å¼‚æ­¥æ“ä½œï¼Œä¸é˜»å¡ž UI

---

## ðŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å¢žé‡ä¿å­˜**: åªä¿å­˜å˜åŒ–çš„éƒ¨åˆ†ï¼Œå‡å°‘å­˜å‚¨å¼€é”€
2. **åŽ‹ç¼©å­˜å‚¨**: å¯¹é•¿æ–‡æœ¬è¿›è¡ŒåŽ‹ç¼©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
3. **å¤šç‰ˆæœ¬è‰ç¨¿**: ä¿å­˜å¤šä¸ªç‰ˆæœ¬çš„è‰ç¨¿ï¼Œæ”¯æŒæ’¤é”€
4. **äº‘ç«¯åŒæ­¥**: å°†è‰ç¨¿åŒæ­¥åˆ°äº‘ç«¯ï¼Œè·¨è®¾å¤‡æ¢å¤

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2026-01-24  
**è®¾è®¡è€…**: AI Product Engineer (Google 20å¹´ç»éªŒ)  
**çŠ¶æ€**: âœ… å·²å®žçŽ°å¹¶éªŒè¯
