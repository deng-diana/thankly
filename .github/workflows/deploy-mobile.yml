name: Build Mobile App

# ğŸ¯ è§¦å‘æ¡ä»¶ä¼˜åŒ–ï¼š
# 1. åªåœ¨åˆ›å»º tag æ—¶è‡ªåŠ¨æ„å»ºï¼ˆä¾‹å¦‚ï¼šv1.1.0ï¼‰
# 2. æˆ–è€…æ‰‹åŠ¨è§¦å‘
# è¿™æ ·å¹³æ—¶æäº¤ä»£ç ä¸ä¼šè§¦å‘æ„å»ºï¼ŒèŠ‚çœæ—¶é—´å’Œèµ„æº
on:
  # å½“æ¨é€ tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ï¼šgit tag v1.1.0 && git push --tagsï¼‰
  push:
    tags:
      - "v*.*.*" # åŒ¹é… v1.0.0, v1.1.0 ç­‰ç‰ˆæœ¬å·

  # æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"ï¼‰
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to build"
        required: true
        default: "ios"
        type: choice
        options:
          - ios
          - android
          - both

jobs:
  build:
    name: Build ${{ github.event.inputs.platform || 'iOS' }} App
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Node.jsï¼ˆä½¿ç”¨ Node.js 20ï¼Œå› ä¸ºæŸäº›ä¾èµ–éœ€è¦ 20+ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      - name: Install dependencies
        working-directory: ./mobile
        run: npm ci

      # æ­¥éª¤ 4: è¿è¡Œé¢„æ„å»ºæ£€æŸ¥
      - name: Run pre-build check
        working-directory: ./mobile
        run: npm run pre-build-check

      # æ­¥éª¤ 5: å®‰è£… EAS CLIï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰
      - name: Install EAS CLI
        run: npm install -g eas-cli@latest

      # æ­¥éª¤ 6: éªŒè¯ EXPO_TOKENï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
      - name: Verify Expo Token
        working-directory: ./mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN æœªé…ç½®ï¼Œæ— æ³•ç»§ç»­"
            echo "è¯·åœ¨ GitHub Settings > Secrets > Actions ä¸­æ·»åŠ  EXPO_TOKEN"
            echo "è·å–æ–¹æ³•: https://expo.dev/accounts/[your-account]/settings/access-tokens"
            exit 1
          fi
          echo "âœ… EXPO_TOKEN å·²é…ç½®"
          echo "éªŒè¯è´¦æˆ·ä¿¡æ¯..."
          eas whoami

      # æ­¥éª¤ 7: æ„å»ºåº”ç”¨ï¼ˆæ ¹æ®è¾“å…¥é€‰æ‹©å¹³å°ï¼‰
      - name: Build iOS App
        if: |
          github.event.inputs.platform == 'ios' || 
          github.event.inputs.platform == 'both' || 
          (github.event.inputs.platform == null && github.event_name == 'push')
        working-directory: ./mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas build --platform ios --non-interactive

      - name: Build Android App
        if: |
          github.event.inputs.platform == 'android' || 
          github.event.inputs.platform == 'both'
        working-directory: ./mobile
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas build --platform android --non-interactive

      # æ­¥éª¤ 8: æ„å»ºå®Œæˆé€šçŸ¥
      - name: Build success
        run: |
          echo "âœ… æ„å»ºæˆåŠŸï¼"
          echo "å¹³å°: ${{ github.event.inputs.platform || 'iOS' }}"
