name: Deploy Backend to AWS Lambda

# ğŸ¯ è§¦å‘æ¡ä»¶ä¼˜åŒ–ï¼š
# 1. åªåœ¨åˆ›å»º backend tag æ—¶è‡ªåŠ¨éƒ¨ç½²ï¼ˆä¾‹å¦‚ï¼šbackend-v1.1.0ï¼‰
# 2. æˆ–è€…æ‰‹åŠ¨è§¦å‘
# è¿™æ ·å¹³æ—¶æäº¤ä»£ç ä¸ä¼šè§¦å‘éƒ¨ç½²ï¼ŒèŠ‚çœæ—¶é—´å’Œèµ„æº
on:
  # å½“æ¨é€ backend tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ï¼šgit tag backend-v1.1.0 && git push --tagsï¼‰
  push:
    tags:
      - "backend-v*.*.*" # åŒ¹é… backend-v1.0.0, backend-v1.1.0 ç­‰

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"ï¼‰
  workflow_dispatch:

# ç¯å¢ƒå˜é‡ï¼ˆä» GitHub Secrets è¯»å–ï¼‰
env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPO_NAME: gratitude-diary
  LAMBDA_FUNCTION_NAME: gratitude-diary-api

jobs:
  deploy:
    name: Build and Deploy to Lambda
    runs-on: ubuntu-latest # ä½¿ç”¨ Ubuntu è™šæ‹Ÿæœºè¿è¡Œ

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: é…ç½® AWS å‡­è¯
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # æ­¥éª¤ 3: ç™»å½•åˆ° Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # æ­¥éª¤ 4: è®¾ç½® QEMUï¼ˆç”¨äºè·¨å¹³å°æ„å»º arm64ï¼‰
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # æ­¥éª¤ 5: è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤ 6: æ„å»ºå¹¶æ¨é€ arm64 é•œåƒï¼ˆDocker V2 schemaï¼‰
      - name: Build and push Docker image (arm64)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # ä½¿ç”¨ buildx æ„å»º arm64 é•œåƒå¹¶ç›´æ¥æ¨é€åˆ° ECR
          # --platform linux/arm64: æŒ‡å®šç›®æ ‡æ¶æ„ä¸º ARM64ï¼ˆä¸ Lambda arm64 æ¶æ„ä¸€è‡´ï¼‰
          # --push: ç›´æ¥æ¨é€åˆ° registryï¼ˆè·¨å¹³å°æ„å»ºå¿…é¡»ä½¿ç”¨ --pushï¼Œä¸èƒ½ --loadï¼‰
          # --provenance=false --sbom=false: ç¦ç”¨ OCI ç›¸å…³ç‰¹æ€§ï¼Œç¡®ä¿ä½¿ç”¨ Docker V2 schemaï¼ˆLambda è¦æ±‚ï¼‰
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --provenance=false \
            --sbom=false \
            -t $ECR_REGISTRY/${{ env.ECR_REPO_NAME }}:latest \
            backend

      # æ­¥éª¤ 7: æ›´æ–° Lambda å‡½æ•°
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:latest \
            --region ${{ env.AWS_REGION }}

      # æ­¥éª¤ 8: ç­‰å¾… Lambda æ›´æ–°å®Œæˆ
      - name: Wait for Lambda update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      # æ­¥éª¤ 9: éƒ¨ç½²æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment success
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "Lambda å‡½æ•°: ${{ env.LAMBDA_FUNCTION_NAME }}"
          echo "é•œåƒ: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:latest"
